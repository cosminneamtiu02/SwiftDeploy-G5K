name: Shell quality

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug mode (prints more logs, runs self-test)"
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

env:
  # true when: manual run with debug=true OR PR has label "ci-debug"
  DEBUG: ${{ (github.event_name == 'workflow_dispatch' && inputs.debug)
           || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'ci-debug')) }}
  # Optional file at repo root listing directories to scan for the advisory job
  SHELL_PATHS_FILE: ".shell_paths"

jobs:
  # ================= 0) Sanity/self-test (only in debug mode) =================
  sanity_debug:
    name: Sanity & self-test
    runs-on: ubuntu-latest
    if: env.DEBUG == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y shellcheck
          SHFMT_VERSION=3.9.0
          curl -sSL https://github.com/mvdan/sh/releases/download/v${SHFMT_VERSION}/shfmt_v${SHFMT_VERSION}_linux_amd64.tar.gz \
            | sudo tar -xz -C /usr/local/bin shfmt
          shellcheck --version
          shfmt -version

      - name: Create throwaway scripts (good/bad)
        run: |
          set -euxo pipefail
          mkdir -p .ci-selftest
          cat > .ci-selftest/good.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          msg="hello"
          echo "$msg"
          EOF
          chmod +x .ci-selftest/good.sh

          # has: unquoted var + formatting issues
          cat > .ci-selftest/bad.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          msg=hello
          echo $msg
          if [ "$msg" = "hello" ]; then
          echo ok
          fi
          EOF
          chmod +x .ci-selftest/bad.sh

      - name: shellcheck should report findings
        run: |
          set +e
          shellcheck -x -S style -f gcc .ci-selftest/good.sh .ci-selftest/bad.sh
          ec=$?
          echo "shellcheck exit: $ec (expect non-zero)"; test $ec -ne 0

      - name: shfmt should show diff for bad.sh
        run: |
          set -e
          if shfmt -i 2 -ci -d .ci-selftest/*.sh; then
            echo "Unexpected: shfmt returned 0 (no diff)"; exit 1
          else
            echo "Expected: shfmt returned non-zero due to formatting diff"
          fi

      - name: bash -n should parse both
        run: |
          set -e
          bash -n .ci-selftest/good.sh
          bash -n .ci-selftest/bad.sh
          echo "Syntax OK"

  # ================= 1) Advisory reviewer (comments + SARIF; non-blocking) =================
  reviewer_advice:
    name: Shell review (advisory)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y shellcheck
          SHFMT_VERSION=3.9.0
          curl -sSL https://github.com/mvdan/sh/releases/download/v${SHFMT_VERSION}/shfmt_v${SHFMT_VERSION}_linux_amd64.tar.gz \
            | sudo tar -xz -C /usr/local/bin shfmt
          echo "== Versions =="; shellcheck --version; shfmt -version

      - name: Setup reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_v_
